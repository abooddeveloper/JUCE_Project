#include "MainComponent.h"

// ==============================================================================
// البناء - تهيئة المكون الرئيسي
// ==============================================================================
MainComponent::MainComponent()
    : audioPlayer(),
    guiComponent(audioPlayer)
{
    addAndMakeVisible(guiComponent); // إضافة واجهة المستخدم وجعلها مرئية
    setSize(600, 350); // تحديد حجم المكون

    // بدء المؤقت للتحديثات الدورية (حوالي 30 إطار في الثانية)
    startTimer(33);
}

// ==============================================================================
// التدمير - تنظيف الموارد
// ==============================================================================
MainComponent::~MainComponent()
{
    stopTimer(); // إيقاف المؤقت
    shutdownAudio(); // إيقاف نظام الصوت
}

// ==============================================================================
// تحضير الصوت للتشغيل
// ==============================================================================
void MainComponent::prepareToPlay(int samplesPerBlockExpected, double sampleRate)
{
    // تحضير معالج الصوت للتشغيل
    audioPlayer.prepareToPlay(samplesPerBlockExpected, sampleRate);
}

// ==============================================================================
// الحصول على كتلة الصوت التالية
// ==============================================================================
void MainComponent::getNextAudioBlock(const juce::AudioSourceChannelInfo& bufferToFill)
{
    // الحصول على كتلة الصوت التالية من المعالج
    audioPlayer.getNextAudioBlock(bufferToFill);
}

// ==============================================================================
// تحرير موارد الصوت
// ==============================================================================
void MainComponent::releaseResources()
{
    // تحرير موارد الصوت
    audioPlayer.releaseResources();
}

// ==============================================================================
// رد نداء المؤقت - للتحديثات الدورية
// ==============================================================================
void MainComponent::timerCallback()
{
    static int counter = 0;
    if (counter++ % 100 == 0) // كل 3 ثوان تقريباً (100 * 33ms ≈ 3.3s)
    {
        if (audioPlayer.isPlaying())
        {
            // طباعة معلومات التصحيح أثناء التشغيل (باستخدام أحرف ASCII فقط)
            DBG("Audio is PLAYING - Position: " +
                juce::String(audioPlayer.getCurrentPosition(), 2) +
                " | Looping: " + juce::String(audioPlayer.isLooping() ? "ON" : "OFF"));
        }
    }
}

// ==============================================================================
// الرسم - رسم خلفية المكون
// ==============================================================================
void MainComponent::paint(juce::Graphics& g)
{
    // رسم خلفية المكون
    g.fillAll(juce::Colours::darkgrey);
}

// ==============================================================================
// إعادة التحجيم - ضبط حدود المكونات الداخلية
// ==============================================================================
void MainComponent::resized()
{
    // ضبط حدود واجهة المستخدم لتملأ المكون بالكامل
    guiComponent.setBounds(getLocalBounds());
}